<!DOCTYPE html>
<html>
<head>
    <title>Full Poker Game Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #1a1a1a; 
            color: #fff;
        }
        .container { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 20px; }
        .panel { 
            background: #2d2d2d; 
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid #444;
        }
        .poker-table { 
            background: linear-gradient(135deg, #0f5132, #198754); 
            border-radius: 20px; 
            padding: 30px; 
            text-align: center;
            min-height: 400px;
        }
        .players-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin: 20px 0;
        }
        .player-seat { 
            background: rgba(0,0,0,0.3); 
            padding: 15px; 
            border-radius: 10px;
            border: 2px solid transparent;
        }
        .player-seat.to-act { 
            border-color: #ffc107; 
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .btn { 
            background: #0d6efd; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #6c757d; cursor: not-allowed; }
        .btn-success { background: #198754; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #fd7e14; }
        input, select { 
            width: 100%; 
            padding: 8px; 
            margin: 5px 0; 
            border: 1px solid #555; 
            border-radius: 4px; 
            background: #3d3d3d; 
            color: #fff;
        }
        .status { 
            background: #2d2d2d; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0; 
            border-left: 4px solid #0d6efd;
        }
        .error { border-left-color: #dc3545; background: rgba(220, 53, 69, 0.1); }
        .success { border-left-color: #198754; background: rgba(25, 135, 84, 0.1); }
        .pot-info { font-size: 24px; font-weight: bold; color: #ffc107; margin: 15px 0; }
        .game-info { font-size: 14px; color: #adb5bd; margin: 10px 0; }
        .actions-panel { background: #3d3d3d; padding: 15px; border-radius: 10px; margin: 10px 0; }
        .bet-input { display: flex; gap: 10px; align-items: center; margin: 10px 0; }
        .bet-input input { flex: 1; }
    </style>
</head>
<body>
    <h1>ðŸŽ° Full Poker Game Test</h1>
    
    <div class="container">
        <!-- Game Setup Panel -->
        <div class="panel">
            <h3>ðŸŽ® Game Setup</h3>
            
            <div>
                <label>Small Blind:</label>
                <input type="number" id="smallBlind" value="1" min="1">
            </div>
            
            <div>
                <label>Big Blind:</label>
                <input type="number" id="bigBlind" value="2" min="1">
            </div>
            
            <div>
                <label>Max Players:</label>
                <input type="number" id="maxPlayers" value="6" min="2" max="10">
            </div>
            
            <button class="btn btn-success" onclick="createGame()">Create Game</button>
            
            <div class="status" id="gameStatus">No game created yet</div>
            
            <hr style="margin: 20px 0; border-color: #555;">
            
            <h4>ðŸ‘¤ Add Player</h4>
            
            <div>
                <label>Player Name:</label>
                <input type="text" id="playerName" placeholder="Enter name">
            </div>
            
            <div>
                <label>Buy-in Amount:</label>
                <input type="number" id="buyInAmount" value="100" min="1">
            </div>
            
            <button class="btn" onclick="addPlayer()" id="addPlayerBtn" disabled>Join Game</button>
            <button class="btn btn-warning" onclick="startHand()" id="startHandBtn" disabled>Start Hand</button>
        </div>

        <!-- Poker Table -->
        <div class="poker-table">
            <div class="game-info">
                <div>Game ID: <span id="currentGameId">-</span></div>
                <div>Hand #<span id="handNumber">0</span> | Street: <span id="currentStreet">-</span></div>
            </div>
            
            <div class="pot-info">ðŸ’° Pot: $<span id="potAmount">0</span></div>
            
            <div id="winnerAnnouncement" style="background: linear-gradient(135deg, #ffc107, #fd7e14); color: #000; padding: 15px; border-radius: 10px; margin: 15px 0; font-weight: bold; text-align: center; display: none;">
                <div id="winnerText"></div>
            </div>
            
            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h4>Community Cards</h4>
                <div id="communityCards">No cards dealt yet</div>
            </div>
            
            <div class="players-grid" id="playersGrid"></div>
        </div>

        <!-- Player Actions Panel -->
        <div class="panel">
            <h3>ðŸŽ² Player Actions</h3>
            
            <div>
                <label>Acting as Player:</label>
                <select id="actingPlayer">
                    <option value="">Select player...</option>
                </select>
            </div>
            
            <div class="status" id="actionsStatus">Select a player to see available actions</div>
            
            <div class="actions-panel" id="actionsPanel"></div>
            
            <div class="bet-input" id="betInput" style="display: none;">
                <label>Amount:</label>
                <input type="number" id="betAmount" min="1" placeholder="Enter amount">
                <button class="btn" onclick="placeBet()">Place Bet</button>
            </div>
            
            <hr style="margin: 20px 0; border-color: #555;">
            
            <h4>ðŸ”„ Game Controls</h4>
            <button class="btn" onclick="refreshGameState()" id="refreshBtn" disabled>Refresh State</button>
            <button class="btn btn-danger" onclick="resetGame()">Reset</button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentGame = null;
        let currentPlayers = [];
        let playerCount = 0;

        // Create a new game
        async function createGame() {
            const smallBlind = parseInt(document.getElementById('smallBlind').value);
            const bigBlind = parseInt(document.getElementById('bigBlind').value);
            const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
            
            try {
                const response = await fetch(`${API_BASE}/games`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        small_blind: smallBlind,
                        big_blind: bigBlind,
                        max_players: maxPlayers
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create game');
                }
                
                currentGame = await response.json();
                document.getElementById('currentGameId').textContent = currentGame.gameId;
                document.getElementById('addPlayerBtn').disabled = false;
                
                showStatus('Game created successfully!', 'success');
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Add a player to the game
        async function addPlayer() {
            const playerName = document.getElementById('playerName').value.trim();
            const buyInAmount = parseInt(document.getElementById('buyInAmount').value);
            
            if (!playerName) {
                showStatus('Please enter a player name', 'error');
                return;
            }
            
            if (!currentGame) {
                showStatus('Please create a game first', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/games/${currentGame.gameId}/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        player_name: playerName,
                        buy_in_amount: buyInAmount
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to join game');
                }
                
                const result = await response.json();
                playerCount++;
                
                // Add to player selector
                const select = document.getElementById('actingPlayer');
                const option = document.createElement('option');
                option.value = result.playerId;
                option.textContent = playerName;
                select.appendChild(option);
                
                // Clear input
                document.getElementById('playerName').value = '';
                
                // Enable start hand button if enough players
                if (playerCount >= 2) {
                    document.getElementById('startHandBtn').disabled = false;
                }
                
                document.getElementById('refreshBtn').disabled = false;
                
                showStatus(`${playerName} joined the game!`, 'success');
                refreshGameState();
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Start a new hand
        async function startHand() {
            if (!currentGame) {
                showStatus('No game found', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/games/${currentGame.gameId}/start-hand`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to start hand');
                }
                
                const result = await response.json();
                showStatus('Hand started!', 'success');
                refreshGameState();
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Refresh game state
        async function refreshGameState() {
            if (!currentGame) return;
            
            try {
                const response = await fetch(`${API_BASE}/games/${currentGame.gameId}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to get game state');
                }
                
                const gameState = await response.json();
                updateGameDisplay(gameState);
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Update game display
        function updateGameDisplay(gameState) {
            // Update basic info
            document.getElementById('handNumber').textContent = gameState.handNumber || 0;
            document.getElementById('currentStreet').textContent = gameState.street || 'WAITING';
            document.getElementById('potAmount').textContent = gameState.pot || 0;
            
            // Show winner if hand is complete
            if (gameState.status === 'COMPLETED' || gameState.street === 'SHOWDOWN') {
                showWinnerAnnouncement(gameState);
            } else {
                document.getElementById('winnerAnnouncement').style.display = 'none';
            }
            
            // Update community cards
            const communityCardsDiv = document.getElementById('communityCards');
            if (gameState.communityCards && gameState.communityCards.length > 0) {
                communityCardsDiv.innerHTML = gameState.communityCards.map(card => 
                    `<span style="display: inline-block; width: 40px; height: 56px; background: white; color: black; border-radius: 6px; margin: 0 5px; line-height: 56px; font-weight: bold; font-size: 12px; text-align: center; border: 2px solid #333;">${card}</span>`
                ).join('');
            } else {
                communityCardsDiv.innerHTML = '<em>No cards dealt yet</em>';
            }
            
            // Update players
            const playersGrid = document.getElementById('playersGrid');
            playersGrid.innerHTML = '';
            
            if (gameState.players) {
                gameState.players.forEach((player) => {
                    const seatDiv = document.createElement('div');
                    seatDiv.className = 'player-seat';
                    
                    if (player.id === gameState.toAct) {
                        seatDiv.classList.add('to-act');
                    }
                    
                    seatDiv.innerHTML = `
                        <div><strong>${player.name}</strong></div>
                        <div>Seat ${player.seatIndex}</div>
                        <div>Stack: $${player.stack}</div>
                        <div class="game-info">
                            ${player.hasFolded ? 'FOLDED' : 
                              player.isAllIn ? 'ALL-IN' : 
                              player.isActive ? 'ACTIVE' : 'SITTING OUT'}
                        </div>
                        ${player.betThisStreet ? `<div>Bet: $${player.betThisStreet}</div>` : ''}
                        ${player.holeCards && player.holeCards.length > 0 ? 
                            `<div style="background: rgba(255,255,255,0.1); padding: 5px; border-radius: 5px; margin-top: 5px;">
                                <div style="font-size: 12px; color: #ffc107;">ðŸ‚  Hole Cards:</div>
                                <div style="font-weight: bold; color: #fff;">${player.holeCards.join(' ')}</div>
                                <div id="hand-eval-${player.id}" style="font-size: 11px; color: #00ff88; margin-top: 3px;"></div>
                            </div>` : ''}
                    `;
                    
                    playersGrid.appendChild(seatDiv);
                    
                    // Evaluate and display hand strength if player has cards and community cards
                    if (player.holeCards && player.holeCards.length === 2 && gameState.communityCards && gameState.communityCards.length >= 3) {
                        const handEval = evaluatePlayerHand(player.holeCards, gameState.communityCards);
                        setTimeout(() => {
                            const evalDiv = document.getElementById(`hand-eval-${player.id}`);
                            if (evalDiv) {
                                evalDiv.textContent = `ðŸŽ¯ ${handEval}`;
                            }
                        }, 100);
                    }
                });
            }
            
            // Update legal actions for selected player
            updateLegalActions();
        }
        
        // Hand evaluation function
        function evaluatePlayerHand(holeCards, communityCards) {
            if (holeCards.length !== 2) return 'Need 2 hole cards';
            if (communityCards.length < 3) return 'Need community cards';
            
            // Combine hole and community cards
            const allCards = [...holeCards, ...communityCards];
            const cards = allCards.map(cardStr => parseCard(cardStr)).filter(c => c !== null);
            
            if (cards.length < 5) return 'Need at least 5 cards';
            
            // Find the best 5-card hand
            const bestHand = findBestHand(cards);
            return bestHand;
        }
        
        // Parse card string like "AS" (Ace of Spades) into rank and suit
        function parseCard(cardStr) {
            if (!cardStr || cardStr.length < 2) return null;
            
            const rank = cardStr.slice(0, -1);  // Everything except last character
            const suit = cardStr.slice(-1);     // Last character
            
            const rankValues = {'2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, 'T': 10, 'J': 11, 'Q': 12, 'K': 13, 'A': 14};
            const suitSymbols = {'S': 'â™ ', 'H': 'â™¥', 'D': 'â™¦', 'C': 'â™£'};
            
            return {
                rank: rankValues[rank] || parseInt(rank),
                suit: suit,
                suitSymbol: suitSymbols[suit] || suit,
                original: cardStr
            };
        }
        
        // Find best poker hand from 5+ cards
        function findBestHand(cards) {
            if (cards.length < 5) return 'Not enough cards';
            
            // Sort cards by rank (high to low)
            cards.sort((a, b) => b.rank - a.rank);
            
            // Check for different hand types
            const ranks = cards.map(c => c.rank);
            const suits = cards.map(c => c.suit);
            
            // Count rank frequencies
            const rankCounts = {};
            ranks.forEach(rank => {
                rankCounts[rank] = (rankCounts[rank] || 0) + 1;
            });
            
            const counts = Object.values(rankCounts).sort((a, b) => b - a);
            const pairs = Object.entries(rankCounts).filter(([rank, count]) => count >= 2);
            
            // Check for flush
            const suitCounts = {};
            suits.forEach(suit => {
                suitCounts[suit] = (suitCounts[suit] || 0) + 1;
            });
            const isFlush = Object.values(suitCounts).some(count => count >= 5);
            
            // Check for straight
            const uniqueRanks = [...new Set(ranks)].sort((a, b) => b - a);
            const isStraight = checkStraight(uniqueRanks);
            
            // Determine hand type
            if (isFlush && isStraight) {
                return isStraight.high === 14 ? 'Royal Flush' : `Straight Flush (${getRankName(isStraight.high)} high)`;
            }
            
            if (counts[0] === 4) {
                const quadRank = Object.entries(rankCounts).find(([rank, count]) => count === 4)[0];
                return `Four of a Kind (${getRankName(parseInt(quadRank))}s)`;
            }
            
            if (counts[0] === 3 && counts[1] === 2) {
                const trips = Object.entries(rankCounts).find(([rank, count]) => count === 3)[0];
                const pair = Object.entries(rankCounts).find(([rank, count]) => count === 2)[0];
                return `Full House (${getRankName(parseInt(trips))}s over ${getRankName(parseInt(pair))}s)`;
            }
            
            if (isFlush) {
                return `Flush (${getRankName(Math.max(...ranks))} high)`;
            }
            
            if (isStraight) {
                return `Straight (${getRankName(isStraight.high)} high)`;
            }
            
            if (counts[0] === 3) {
                const trips = Object.entries(rankCounts).find(([rank, count]) => count === 3)[0];
                return `Three of a Kind (${getRankName(parseInt(trips))}s)`;
            }
            
            if (pairs.length === 2) {
                const pairRanks = pairs.map(([rank, count]) => parseInt(rank)).sort((a, b) => b - a);
                return `Two Pair (${getRankName(pairRanks[0])}s and ${getRankName(pairRanks[1])}s)`;
            }
            
            if (pairs.length === 1) {
                const pairRank = parseInt(pairs[0][0]);
                return `Pair of ${getRankName(pairRank)}s`;
            }
            
            return `High Card (${getRankName(Math.max(...ranks))})`;
        }
        
        // Check for straight
        function checkStraight(ranks) {
            // Check for regular straight
            for (let i = 0; i <= ranks.length - 5; i++) {
                if (ranks[i] - ranks[i + 4] === 4) {
                    return { high: ranks[i], low: ranks[i + 4] };
                }
            }
            
            // Check for A-2-3-4-5 straight (wheel)
            if (ranks.includes(14) && ranks.includes(5) && ranks.includes(4) && ranks.includes(3) && ranks.includes(2)) {
                return { high: 5, low: 1 };
            }
            
            return false;
        }
        
        // Get readable rank name
        function getRankName(rank) {
            const names = {2: 'Two', 3: 'Three', 4: 'Four', 5: 'Five', 6: 'Six', 7: 'Seven', 8: 'Eight', 9: 'Nine', 10: 'Ten', 11: 'Jack', 12: 'Queen', 13: 'King', 14: 'Ace'};
            return names[rank] || rank.toString();
        }

        // Update legal actions for selected player
        async function updateLegalActions() {
            const selectedPlayer = document.getElementById('actingPlayer').value;
            if (!selectedPlayer || !currentGame) {
                document.getElementById('actionsStatus').textContent = 'Select a player to see available actions';
                document.getElementById('actionsPanel').innerHTML = '';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/games/${currentGame.gameId}/legal-actions?player_id=${selectedPlayer}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to get legal actions');
                }
                
                const result = await response.json();
                const actions = result.legalActions || [];
                
                if (actions.length === 0) {
                    document.getElementById('actionsStatus').textContent = 'No actions available for this player';
                    document.getElementById('actionsPanel').innerHTML = '';
                    return;
                }
                
                document.getElementById('actionsStatus').textContent = `Available actions for ${selectedPlayer}:`;
                
                const actionsPanel = document.getElementById('actionsPanel');
                actionsPanel.innerHTML = '';
                
                actions.forEach(action => {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    button.textContent = action;
                    button.onclick = () => performAction(action);
                    
                    if (action === 'FOLD') button.classList.add('btn-danger');
                    else if (action === 'CHECK' || action === 'CALL') button.classList.add('btn-success');
                    else if (action === 'BET' || action === 'RAISE') button.classList.add('btn-warning');
                    
                    actionsPanel.appendChild(button);
                });
                
                // Show bet input for betting actions
                const needsBetAmount = actions.some(a => ['BET', 'RAISE'].includes(a));
                document.getElementById('betInput').style.display = needsBetAmount ? 'flex' : 'none';
                
            } catch (error) {
                document.getElementById('actionsStatus').textContent = `Error: ${error.message}`;
            }
        }

        // Perform player action
        async function performAction(action) {
            const selectedPlayer = document.getElementById('actingPlayer').value;
            if (!selectedPlayer || !currentGame) return;
            
            let amount = null;
            if (['BET', 'RAISE'].includes(action)) {
                amount = parseInt(document.getElementById('betAmount').value);
                if (!amount || amount <= 0) {
                    showStatus('Please enter a valid bet amount', 'error');
                    return;
                }
            }
            
            try {
                const body = {
                    player_id: selectedPlayer,
                    action: action
                };
                
                if (amount) {
                    body.amount = amount;
                }
                
                const response = await fetch(`${API_BASE}/games/${currentGame.gameId}/actions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to perform action');
                }
                
                const result = await response.json();
                showStatus(`Action performed: ${action}`, 'success');
                
                // Clear bet amount
                document.getElementById('betAmount').value = '';
                
                // Refresh after a short delay to see the update
                setTimeout(refreshGameState, 100);
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Reset game
        function resetGame() {
            currentGame = null;
            currentPlayers = [];
            playerCount = 0;
            
            document.getElementById('currentGameId').textContent = '-';
            document.getElementById('handNumber').textContent = '0';
            document.getElementById('currentStreet').textContent = '-';
            document.getElementById('potAmount').textContent = '0';
            document.getElementById('communityCards').innerHTML = '';
            document.getElementById('playersGrid').innerHTML = '';
            
            document.getElementById('addPlayerBtn').disabled = true;
            document.getElementById('startHandBtn').disabled = true;
            document.getElementById('refreshBtn').disabled = true;
            
            document.getElementById('actingPlayer').innerHTML = '<option value="">Select player...</option>';
            document.getElementById('actionsPanel').innerHTML = '';
            
            showStatus('Game reset', 'success');
        }

        // Show winner announcement
        function showWinnerAnnouncement(gameState) {
            if (!gameState.players || gameState.players.length === 0) return;
            
            // Find players with highest stack (indicating they won money)
            const initialStack = 100; // Assume starting stack for comparison
            const winners = gameState.players.filter(p => p.stack > initialStack);
            const losers = gameState.players.filter(p => p.stack < initialStack);
            
            if (winners.length > 0) {
                const winnerText = winners.length === 1 ? 
                    `ðŸ† ${winners[0].name} wins with $${winners[0].stack}!` :
                    `ðŸ† ${winners.map(w => w.name).join(', ')} win the hand!`;
                
                const loserText = losers.length > 0 ? 
                    ` ${losers.map(l => `${l.name}: $${l.stack}`).join(', ')}` : '';
                
                document.getElementById('winnerText').innerHTML = winnerText + loserText;
                document.getElementById('winnerAnnouncement').style.display = 'block';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    document.getElementById('winnerAnnouncement').style.display = 'none';
                }, 5000);
            }
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('gameStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Event listeners
        document.getElementById('actingPlayer').addEventListener('change', updateLegalActions);

        // Initialize
        showStatus('Ready to create a game!', 'success');
    </script>
</body>
</html>
