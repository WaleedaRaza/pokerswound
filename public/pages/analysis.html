<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis & Data - PokerGeek.ai</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;800&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/pokergeek.css">
    <link rel="stylesheet" href="/css/index-modern.css">
    <link rel="stylesheet" href="/css/analytics-live.css">
    <link rel="stylesheet" href="/css/analytics-modern.css">
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Unified Auth System -->
    <script src="/js/auth-manager.js"></script>
    <script src="/js/nav-shared.js"></script>
    <script src="/js/navbar-template.js"></script>
    
    <!-- Liquid Glass Controller -->
    <script src="/js/liquid-glass-controller.js"></script>
    
    <!-- Socket.IO for live data -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Hand Encoder for decoding -->
    <script src="/js/hand-encoder.js"></script>
    
    <!-- Analytics Live Data Service -->
    <script src="/js/analytics-live.js"></script>
    
    <!-- Analytics Hand History Service -->
    <script src="/js/analytics-history.js"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Analytics Components -->
    <script src="/js/analytics-components.js"></script>
    
    <!-- Liquid Glass SVG Filter - Locked Values -->
    <svg xmlns="http://www.w3.org/2000/svg" width="0" height="0" style="position:absolute; overflow:hidden">
      <defs>
        <filter id="glass-distortion" x="0%" y="0%" width="100%" height="100%">
          <feTurbulence type="fractalNoise" baseFrequency="0.008 0.008" numOctaves="2" seed="92" result="noise" />
          <feGaussianBlur in="noise" stdDeviation="2" result="blurred" />
          <feDisplacementMap in="SourceGraphic" in2="blurred" scale="39" xChannelSelector="R" yChannelSelector="G" />
        </filter>
      </defs>
    </svg>
</head>
<body>
    <!-- Global floating animations container -->
    <div id="floating-cards" class="floating-cards"></div>
    
    <!-- UNIFIED NAVBAR (Injected by navbar-template.js) -->
    <div id="navbar-container"></div>

    <!-- Main Content -->
    <main class="analytics-page">
        <div class="analytics-hero">
            <h1 class="analytics-hero-title">Analysis</h1>
            <p class="analytics-hero-subtitle">Your poker command center</p>
        </div>
        
        <div class="stats-dashboard">
            <!-- Critical Metrics Row (Mission Control Style) -->
            <div id="analytics-stats-grid" class="stats-grid stats-grid-critical">
                <!-- Stats will be populated by JavaScript -->
            </div>

            <!-- Post-Game Insights Section -->
            <div class="section-card liquid-glass liquid-glass--xl">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                                <path d="M9 11l3 3L22 4"/>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                            </svg>
                            Post-Game Insights
                        </h2>
                        <p class="section-description">Key moments and learning opportunities from your recent hands</p>
                    </div>
                </div>
                <div id="insights-container" class="insights-container">
                    <!-- Insights will be populated by JavaScript -->
                </div>
            </div>

            <!-- Hand History Section -->
            <div class="section-card liquid-glass liquid-glass--xl">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                            </svg>
                            Hand History
                        </h2>
                        <p class="section-description">Review and analyze your past hands</p>
                </div>
            </div>

                <!-- Filters - Simplified Dropdown -->
                <div class="filters-modern">
                    <div class="filter-group-modern">
                        <label>Filter Hands</label>
                        <select id="hand-filter-dropdown" class="filter-input-modern" onchange="applyHandHistoryFilters()">
                            <option value="">All Hands</option>
                            <option value="won">Won Hands</option>
                            <option value="lost">Lost Hands</option>
                            <option value="big-pot">Big Pots ($500+)</option>
                            <option value="royal-flush">Royal Flush</option>
                            <option value="straight-flush">Straight Flush</option>
                            <option value="four-kind">Four of a Kind</option>
                            <option value="full-house">Full House</option>
                            <option value="flush">Flush</option>
                        </select>
                    </div>
                </div>
                    
                    <!-- Hand List -->
                <div id="hand-history-list" style="overflow-x: auto;">
                    <p style="text-align: center; color: #9aa3b2; padding: 40px;">Loading hands...</p>
                    </div>
                    
                    <!-- Pagination -->
                <div id="history-pagination" class="pagination-modern">
                    <button onclick="loadPreviousPage()" id="btn-prev" class="pagination-btn-modern" disabled>‚Üê Previous</button>
                    <span id="page-info" class="pagination-info-modern">Page 1 of 1</span>
                    <button onclick="loadNextPage()" id="btn-next" class="pagination-btn-modern">Next ‚Üí</button>
                </div>
            </div>

            <!-- Badges & Achievements -->
            <div class="section-card liquid-glass liquid-glass--xl">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/>
                                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
                                <path d="M4 22h16"/>
                                <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/>
                                <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/>
                                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
                            </svg>
                            Badges & Achievements
                        </h2>
                        <p class="section-description">Unlock achievements and level up your rank</p>
                    </div>
                </div>
                
                <div id="badges-container" class="badges-section"></div>

                <div id="rank-container" class="rank-card-modern liquid-glass liquid-glass--lg">
                    <div class="rank-icon-modern">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                        </svg>
                    </div>
                    <div class="rank-info-modern">
                        <div class="rank-label-modern">Your Rank</div>
                        <div id="rank-title" class="rank-title-modern">Novice</div>
                        <div class="rank-details-modern">
                            Level <strong id="rank-level">1</strong> ‚Ä¢ 
                            <strong id="rank-xp">0</strong> XP
                </div>
            </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Liquid Glass Controls -->
    <div class="glass-controls">
        <h3>Liquid Glass Controls</h3>
        <div>
            <label>Shadow Blur:</label>
            <input type="range" min="0" max="30" value="20" id="shadow-blur">
        </div>
        <div>
            <label>Tint Opacity:</label>
            <input type="range" min="0" max="20" value="5" id="tint-opacity">
        </div>
        <div>
            <label>Frost Blur:</label>
            <input type="range" min="0" max="30" value="20" id="frost-blur">
        </div>
        <div>
            <label>Distortion:</label>
            <input type="range" min="0" max="100" value="77" id="distortion-strength">
        </div>
        <div class="button-group">
            <button id="lock-values">üîì Lock</button>
            <button onclick="toggleControls()">Hide</button>
        </div>
    </div>

    <!-- Login/Signup Modal -->
    <div id="loginModal" class="modal-overlay" style="display: none;">
      <div class="modal-box">
        <button class="modal-close" onclick="closeLoginModal()">&times;</button>
        <div class="modal-header">
          <h2 class="modal-title">Welcome to PokerGeek</h2>
          <p class="modal-subtitle">Sign in to your account or create a new one</p>
        </div>
        <div class="modal-tabs">
          <button class="modal-tab active" onclick="switchModalTab('login')">Sign In</button>
          <button class="modal-tab" onclick="switchModalTab('signup')">Sign Up</button>
        </div>
        <div id="loginForm" class="modal-form active">
          <button class="btn-google" onclick="handleGoogleAuth()">
            <svg class="google-icon" viewBox="0 0 24 24" width="20" height="20">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Continue with Google
          </button>
          <div class="divider"><span>or</span></div>
          <div class="form-group">
            <label class="form-label">Email Address</label>
            <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email address" required>
            <div class="form-error" id="loginEmailError"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Password</label>
            <div class="password-input">
              <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
              <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">üëÅÔ∏è</button>
            </div>
            <div class="form-error" id="loginPasswordError"></div>
          </div>
          <div class="form-options">
            <div class="checkbox-group">
              <input type="checkbox" class="checkbox" id="remember">
              <label class="checkbox-label" for="remember">Remember me for 30 days</label>
            </div>
            <a href="#" class="forgot-link" onclick="showForgotPassword()">Forgot password?</a>
          </div>
          <button class="btn-submit" onclick="handleLogin()">Sign In to PokerGeek</button>
          <div class="form-footer">
            <p>Don't have an account? <a href="#" onclick="switchModalTab('signup')">Create one here</a></p>
          </div>
        </div>
        <div id="signupForm" class="modal-form">
          <button class="btn-google" onclick="handleGoogleAuth()">
            <svg class="google-icon" viewBox="0 0 24 24" width="20" height="20">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Continue with Google
          </button>
          <div class="divider"><span>or</span></div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">First Name</label>
              <input type="text" class="form-input" id="signupFirstName" placeholder="First name" required>
              <div class="form-error" id="signupFirstNameError"></div>
            </div>
            <div class="form-group">
              <label class="form-label">Last Name</label>
              <input type="text" class="form-input" id="signupLastName" placeholder="Last name" required>
              <div class="form-error" id="signupLastNameError"></div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Email Address</label>
            <input type="email" class="form-input" id="signupEmail" placeholder="Enter your email address" required>
            <div class="form-error" id="signupEmailError"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Username</label>
            <input type="text" class="form-input" id="signupUsername" placeholder="Choose a username" required>
            <div class="form-error" id="signupUsernameError"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Password</label>
            <div class="password-input">
              <input type="password" class="form-input" id="signupPassword" placeholder="Create a password" required>
              <button type="button" class="password-toggle" onclick="togglePassword('signupPassword')">üëÅÔ∏è</button>
            </div>
            <div class="password-strength" id="passwordStrength"></div>
            <div class="form-error" id="signupPasswordError"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Confirm Password</label>
            <div class="password-input">
              <input type="password" class="form-input" id="signupConfirmPassword" placeholder="Confirm your password" required>
              <button type="button" class="password-toggle" onclick="togglePassword('signupConfirmPassword')">üëÅÔ∏è</button>
            </div>
            <div class="form-error" id="signupConfirmPasswordError"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Date of Birth</label>
            <input type="date" class="form-input" id="signupBirthDate" required>
            <div class="form-error" id="signupBirthDateError"></div>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" class="checkbox" id="terms" required>
            <label class="checkbox-label" for="terms">I agree to the <a href="#" class="link">Terms of Service</a> and <a href="#" class="link">Privacy Policy</a></label>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" class="checkbox" id="newsletter">
            <label class="checkbox-label" for="newsletter">Subscribe to our newsletter for updates and promotions</label>
          </div>
          <button class="btn-submit" onclick="handleSignup()">Create Account</button>
          <div class="form-footer">
            <p>Already have an account? <a href="#" onclick="switchModalTab('login')">Sign in here</a></p>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <a href="index.html" class="footer-logo">PokerGeek.ai</a>
            <p class="footer-desc">Building the world's most transparent poker platform with provably fair shuffling and cryptographic verification.</p>
            <div class="footer-links">
                <a href="#privacy">Privacy Policy</a>
                <a href="#terms">Terms of Service</a>
                <a href="#support">Support</a>
                <a href="#contact">Contact</a>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 PokerGeek.ai. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Global animations -->
    <script src="global-animations.js"></script>
    <script>
        // ===== AUTHENTICATION SYSTEM =====
        let isLoggedIn = false;
        let currentUser = null;

        // Check authentication state on page load
        function checkAuthState() {
            const savedUser = localStorage.getItem('pokerUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                isLoggedIn = true;
                updateNavbarForLoggedInUser();
            }
        }

        // Update navbar to show user menu instead of login/signup
        function updateNavbarForLoggedInUser() {
            document.getElementById('navbarAuth').style.display = 'none';
            document.getElementById('navbarUser').style.display = 'flex';
            document.getElementById('userName').textContent = currentUser.username || currentUser.name || 'User';
            document.getElementById('userAvatar').textContent = currentUser.avatar || 'üë§';
        }

        // Update navbar to show login/signup buttons
        function updateNavbarForLoggedOutUser() {
            document.getElementById('navbarAuth').style.display = 'flex';
            document.getElementById('navbarUser').style.display = 'none';
        }

        // Modal functions
        function openLoginModal() {
            document.getElementById('loginModal').classList.add('show');
            document.body.style.overflow = 'hidden';
            switchModalTab('login');
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
            document.body.style.overflow = '';
        }

        function switchModalTab(tab) {
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.modal-form').forEach(f => f.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Form').classList.add('active');
        }

        function openSettingsModal() {
            window.location.href = 'index.html';
        }

        function handleLogout() {
            currentUser = null;
            isLoggedIn = false;
            localStorage.removeItem('pokerUser');
            updateNavbarForLoggedOutUser();
            showNotification('Successfully logged out!', 'success');
        }

        function handleGoogleAuth() {
            const mockUsers = [
                { name: 'Alex Johnson', username: 'alexj', email: 'alex@example.com', avatar: 'üéØ' },
                { name: 'Sarah Wilson', username: 'sarahw', email: 'sarah@example.com', avatar: 'üëë' },
                { name: 'Mike Chen', username: 'mikec', email: 'mike@example.com', avatar: 'üÉè' },
                { name: 'Emma Davis', username: 'emmad', email: 'emma@example.com', avatar: 'üíé' },
                { name: 'Chris Taylor', username: 'christ', email: 'chris@example.com', avatar: '‚ö°' }
            ];
            const randomUser = mockUsers[Math.floor(Math.random() * mockUsers.length)];
            randomUser.provider = 'google';
            currentUser = randomUser;
            isLoggedIn = true;
            localStorage.setItem('pokerUser', JSON.stringify(randomUser));
            updateNavbarForLoggedInUser();
            closeLoginModal();
            showNotification(`Welcome back, ${randomUser.name}!`, 'success');
        }

        function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) {
                showNotification('Please enter both email and password', 'error');
                return;
            }
            const username = email.split('@')[0];
            const name = username.charAt(0).toUpperCase() + username.slice(1) + ' User';
            const mockUser = { name: name, username: username, email: email, avatar: 'üë§', provider: 'email' };
            currentUser = mockUser;
            isLoggedIn = true;
            localStorage.setItem('pokerUser', JSON.stringify(mockUser));
            updateNavbarForLoggedInUser();
            closeLoginModal();
            showNotification(`Welcome back, ${name}!`, 'success');
        }

        function handleSignup() {
            const firstName = document.getElementById('signupFirstName').value;
            const lastName = document.getElementById('signupLastName').value;
            const email = document.getElementById('signupEmail').value;
            const username = document.getElementById('signupUsername').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const birthDate = document.getElementById('signupBirthDate').value;
            const terms = document.getElementById('terms').checked;
            if (!firstName || !lastName || !email || !username || !password) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }
            if (!terms) {
                showNotification('Please agree to the Terms of Service', 'error');
                return;
            }
            const mockUser = { name: `${firstName} ${lastName}`, username: username, email: email, avatar: 'üë§', provider: 'email', birthDate: birthDate };
            currentUser = mockUser;
            isLoggedIn = true;
            localStorage.setItem('pokerUser', JSON.stringify(mockUser));
            updateNavbarForLoggedInUser();
            closeLoginModal();
            showNotification(`Welcome to PokerGeek, ${firstName}!`, 'success');
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        function showForgotPassword() {
            showNotification('Password reset functionality coming soon!', 'info');
        }

        // Notification system
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                    <span class="notification-message">${message}</span>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        // Initialize ongoing animations only
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof initOngoingOnly === 'function') {
                initOngoingOnly();
            }
            checkAuthState(); // Check if user is logged in
        });

        // Tab switching functionality
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            console.log('Switched to tab:', tabName);
        }

        // Liquid Glass Controls
        let isLocked = false;
        
        function toggleControls() {
            const controls = document.querySelector('.glass-controls');
            const button = controls.querySelector('button[onclick="toggleControls()"]');
            
            if (controls.style.display === 'none') {
                controls.style.display = 'block';
                button.textContent = 'Hide';
            } else {
                controls.style.display = 'none';
                button.textContent = 'Show';
            }
        }
        
        function toggleLock() {
            isLocked = !isLocked;
            const lockButton = document.getElementById('lock-values');
            const shadowBlur = document.getElementById('shadow-blur');
            const tintOpacity = document.getElementById('tint-opacity');
            const frostBlur = document.getElementById('frost-blur');
            const distortionStrength = document.getElementById('distortion-strength');
            
            lockButton.textContent = isLocked ? 'üîí Unlock' : 'üîì Lock';
            lockButton.style.background = isLocked ? 'var(--warning)' : 'var(--teal)';
            
            [shadowBlur, tintOpacity, frostBlur, distortionStrength].forEach(slider => {
                slider.disabled = isLocked;
                slider.style.opacity = isLocked ? '0.5' : '1';
            });
        }

        // Initialize liquid glass controls
        document.addEventListener('DOMContentLoaded', function() {
            const root = document.documentElement;
            
            function updateGlassVar(name, value) {
                if (isLocked) return;
                root.style.setProperty(name, value);
            }
            
            function updateSVG() {
                if (isLocked) return;
                
                const distortionStrength = document.getElementById('distortion-strength')?.value || 77;
                const noiseFrequency = 0.008;
                
                const displacementMap = document.querySelector('feDisplacementMap');
                const turbulence = document.querySelector('feTurbulence');
                
                if (displacementMap) displacementMap.setAttribute('scale', distortionStrength);
                if (turbulence) turbulence.setAttribute('baseFrequency', `${noiseFrequency} ${noiseFrequency}`);
            }
            
            const controls = {
                'shadow-blur': ['--glass-shadow-blur', v => v + 'px'],
                'tint-opacity': ['--glass-tint-opacity', v => (v / 100)],
                'frost-blur': ['--glass-frost-blur', v => v + 'px'],
                'distortion-strength': ['--glass-distortion-strength', v => v]
            };
            
            Object.keys(controls).forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', (e) => {
                        const [cssVar, formatter] = controls[id];
                        updateGlassVar(cssVar, formatter(e.target.value));
                        updateSVG();
                    });
                }
            });
            
            const lockButton = document.getElementById('lock-values');
            if (lockButton) {
                lockButton.addEventListener('click', toggleLock);
            }
        });
        
        // Initialize auth on page load
        let currentUser = null;
        let currentPage = 1;
        let currentFilters = {};
        
        // ============================================
        // ANALYTICS DATA LOADING
        // ============================================
        
        async function loadAnalyticsData() {
            if (!currentUser || !currentUser.id) {
                console.warn('‚ö†Ô∏è No user logged in');
                return;
            }
            
            const userId = currentUser.id;
            const token = await window.authManager?.getAccessToken();
            
            if (!token) {
                console.warn('‚ö†Ô∏è No auth token');
                return;
            }
            
            try {
                // Load stats
                await loadStats(userId, token);
                
                // Load hand history
                await loadHandHistory(userId, token, currentPage, currentFilters);
                
                // Generate insights from recent hands
                await generateInsights(userId, token);
                
                // Load charts
                await loadCharts(userId, token);
                
                // Load badges
                await loadBadges(userId, token);
                
            } catch (error) {
                console.error('‚ùå Error loading analytics data:', error);
            }
        }
        
        async function loadStats(userId, token) {
            try {
                const response = await fetch(`/api/social/analytics/stats/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to fetch stats');
                
                const data = await response.json();
                const statsGrid = document.getElementById('analytics-stats-grid');
                
                if (!statsGrid) return;
                
                const winRate = parseFloat(data.lifetime.winRate || 0);
                const status = winRate >= 50 ? 'positive' : winRate >= 40 ? 'warning' : 'negative';
                
                statsGrid.innerHTML = `
                    ${window.AnalyticsComponents.createMetricCard({
                        label: 'WIN RATE',
                        value: `${winRate.toFixed(1)}%`,
                        trend: winRate >= 50 ? 3.1 : -2.4,
                        trendPeriod: 'last 30 days',
                        status: status
                    })}
                    ${window.AnalyticsComponents.createMetricCard({
                        label: 'HANDS PLAYED',
                        value: (data.lifetime.handsPlayed || 0).toLocaleString(),
                        trend: null,
                        status: 'positive'
                    })}
                    ${window.AnalyticsComponents.createMetricCard({
                        label: 'BIGGEST POT',
                        value: `$${(data.lifetime.biggestPot || 0).toLocaleString()}`,
                        trend: null,
                        status: 'positive'
                    })}
                    ${window.AnalyticsComponents.createMetricCard({
                        label: 'CURRENT STREAK',
                        value: (data.advanced.currentStreak || 0).toString(),
                        trend: null,
                        status: (data.advanced.currentStreak || 0) > 0 ? 'positive' : 'negative'
                    })}
                `;
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function loadHandHistory(userId, token, page = 1, filters = {}) {
            try {
                // Build query params - handle won/lost filters client-side
                const params = new URLSearchParams({ page, limit: 20 });
                
                // Add API-compatible filters
                if (filters.minPot) params.append('minPot', filters.minPot);
                if (filters.handRank) params.append('handRank', filters.handRank);
                
                const response = await fetch(`/api/social/analytics/hands/${userId}?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to fetch hand history');
                
                const data = await response.json();
                const container = document.getElementById('hand-history-list');
                
                if (!container) return;
                
                // Filter client-side for won/lost
                let hands = data.hands || [];
                if (filters.won) {
                    hands = hands.filter(h => h.won === true);
                } else if (filters.lost) {
                    hands = hands.filter(h => h.won === false);
                }
                
                container.innerHTML = window.AnalyticsComponents.createHandHistoryTable(
                    hands,
                    (handId) => {
                        console.log('Hand clicked:', handId);
                        // TODO: Open hand detail modal
                    }
                );
                
                // Update pagination with filtered results
                const filteredPagination = {
                    ...data.pagination,
                    total: hands.length,
                    totalPages: Math.ceil(hands.length / 20)
                };
                updatePagination(filteredPagination);
                
            } catch (error) {
                console.error('Error loading hand history:', error);
                const container = document.getElementById('hand-history-list');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state-modern">
                            <div class="empty-state-modern-icon">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                    <line x1="12" y1="9" x2="12" y2="13"/>
                                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                                </svg>
                            </div>
                            <h3>Error loading hands</h3>
                            <p>Please try again later</p>
                        </div>
                    `;
                }
            }
        }
        
        async function loadBadges(userId, token) {
            try {
                const response = await fetch(`/api/social/badges/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to fetch badges');
                
                const data = await response.json();
                
                // Display badges
                const badgesContainer = document.getElementById('badges-container');
                if (badgesContainer) {
                    badgesContainer.innerHTML = window.AnalyticsComponents.createBadgeDisplay(data.badges);
                }
                
                // Display rank
                if (data.rank) {
                    const rankTitle = document.getElementById('rank-title');
                    const rankLevel = document.getElementById('rank-level');
                    const rankXp = document.getElementById('rank-xp');
                    
                    if (rankTitle) rankTitle.textContent = data.rank.title;
                    if (rankLevel) rankLevel.textContent = data.rank.level;
                    if (rankXp) rankXp.textContent = data.rank.xp.toLocaleString();
                }
                
            } catch (error) {
                console.error('Error loading badges:', error);
            }
        }
        
        function updatePagination(pagination) {
            const pageInfo = document.getElementById('page-info');
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');
            
            if (pageInfo) {
                pageInfo.textContent = `Page ${pagination.page} of ${pagination.totalPages}`;
            }
            
            if (btnPrev) {
                btnPrev.disabled = pagination.page <= 1;
            }
            
            if (btnNext) {
                btnNext.disabled = pagination.page >= pagination.totalPages;
            }
        }
        
        // Hand history filter functions - Simplified dropdown
        window.applyHandHistoryFilters = async function() {
            const dropdown = document.getElementById('hand-filter-dropdown');
            const filterValue = dropdown?.value || '';
            
            const filters = {};
            
            // Map dropdown values to API filters
            if (filterValue === 'won') {
                // Filter for won hands - we'll need to check winner_id in the response
                filters.won = true;
            } else if (filterValue === 'lost') {
                filters.lost = true;
            } else if (filterValue === 'big-pot') {
                filters.minPot = 500;
            } else if (filterValue === 'royal-flush') {
                filters.handRank = 1;
            } else if (filterValue === 'straight-flush') {
                filters.handRank = 2;
            } else if (filterValue === 'four-kind') {
                filters.handRank = 3;
            } else if (filterValue === 'full-house') {
                filters.handRank = 4;
            } else if (filterValue === 'flush') {
                filters.handRank = 5;
            }
            
            currentFilters = filters;
            currentPage = 1;
            
            if (currentUser && currentUser.id) {
                const token = await window.authManager?.getAccessToken();
                await loadHandHistory(currentUser.id, token, currentPage, currentFilters);
            }
        };
        
        window.clearHandHistoryFilters = async function() {
            const dropdown = document.getElementById('hand-filter-dropdown');
            if (dropdown) dropdown.value = '';
            
            currentFilters = {};
            currentPage = 1;
            
            if (currentUser && currentUser.id) {
                const token = await window.authManager?.getAccessToken();
                await loadHandHistory(currentUser.id, token, currentPage, currentFilters);
            }
        };
        
        window.loadNextPage = async function() {
            currentPage++;
            if (currentUser && currentUser.id) {
                const token = await window.authManager?.getAccessToken();
                await loadHandHistory(currentUser.id, token, currentPage, currentFilters);
            }
        };
        
        window.loadPreviousPage = async function() {
            if (currentPage > 1) {
                currentPage--;
                if (currentUser && currentUser.id) {
                    const token = await window.authManager?.getAccessToken();
                    await loadHandHistory(currentUser.id, token, currentPage, currentFilters);
                }
            }
        };
        
        window.handleHandClick = function(handId) {
            console.log('Hand clicked:', handId);
            // TODO: Open hand detail modal with LLM analysis
        };
        
        // ============================================
        // GENERATE POST-GAME INSIGHTS
        // ============================================
        async function generateInsights(userId, token) {
            try {
                // Fetch recent hands (last 10)
                const response = await fetch(`/api/social/analytics/hand-history/${userId}?limit=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to fetch hand history');
                
                const data = await response.json();
                const hands = data.hands || [];
                
                if (hands.length === 0) {
                    const container = document.getElementById('insights-container');
                    if (container) {
                        container.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 40px;">Play some games to see insights!</p>';
                    }
                    return;
                }
                
                const insights = [];
                
                // Find biggest pot won
                const biggestPot = hands.filter(h => h.winner_id === userId)
                    .sort((a, b) => (b.pot_size || 0) - (a.pot_size || 0))[0];
                
                if (biggestPot && biggestPot.pot_size > 100) {
                    const boardCards = biggestPot.board_cards ? biggestPot.board_cards.split(' ') : [];
                    insights.push({
                        type: 'good-move',
                        title: `Biggest Pot Won: $${biggestPot.pot_size}`,
                        message: `You won your biggest pot of $${biggestPot.pot_size} with ${biggestPot.winning_hand || 'a strong hand'}.`,
                        handPreview: `
                            <div class="board">Board: ${boardCards.length > 0 ? boardCards.join(' ') : 'N/A'}</div>
                            <div class="your-hand">Your Hand: ${biggestPot.winning_hand || 'N/A'}</div>
                        `,
                        handId: biggestPot.id
                    });
                }
                
                // Find best hand
                const bestHand = hands.filter(h => h.winner_id === userId)
                    .sort((a, b) => (a.hand_rank || 10) - (b.hand_rank || 10))[0];
                
                if (bestHand && bestHand.hand_rank && bestHand.hand_rank <= 5) {
                    const handNames = {
                        1: 'Royal Flush',
                        2: 'Straight Flush',
                        3: 'Four of a Kind',
                        4: 'Full House',
                        5: 'Flush'
                    };
                    const handName = handNames[bestHand.hand_rank] || 'Strong Hand';
                    insights.push({
                        type: 'good-move',
                        title: `Best Hand: ${handName}`,
                        message: `You made ${handName}! This is one of the strongest hands in poker.`,
                        handPreview: `
                            <div class="board">Board: ${bestHand.board_cards || 'N/A'}</div>
                            <div class="your-hand">Your Hand: ${bestHand.winning_hand || 'N/A'}</div>
                        `,
                        handId: bestHand.id
                    });
                }
                
                // Find recent win streak
                const recentWins = hands.filter(h => h.winner_id === userId).length;
                if (recentWins >= 3) {
                    insights.push({
                        type: 'good-move',
                        title: `Win Streak: ${recentWins} Recent Wins`,
                        message: `You've won ${recentWins} out of your last ${Math.min(hands.length, 10)} hands. Keep it up!`,
                        handId: null
                    });
                }
                
                // Find learning opportunities (big pots lost)
                const bigLosses = hands.filter(h => h.winner_id !== userId && h.pot_size > 200)
                    .sort((a, b) => (b.pot_size || 0) - (a.pot_size || 0))
                    .slice(0, 1);
                
                if (bigLosses.length > 0) {
                    const loss = bigLosses[0];
                    insights.push({
                        type: 'learning',
                        title: `Learning Opportunity: $${loss.pot_size} Pot`,
                        message: `You lost a $${loss.pot_size} pot. Review this hand to see what you could have done differently.`,
                        handPreview: `
                            <div class="board">Board: ${loss.board_cards || 'N/A'}</div>
                            <div class="your-hand">Opponent's Hand: ${loss.winning_hand || 'N/A'}</div>
                        `,
                        handId: loss.id
                    });
                }
                
                // Render insights
                const container = document.getElementById('insights-container');
                if (container && insights.length > 0) {
                    container.innerHTML = insights.map(insight => 
                        window.AnalyticsComponents.createInsightCard({
                            ...insight,
                            onClick: insight.handId ? `handleHandClick('${insight.handId}')` : null
                        })
                    ).join('');
                } else if (container) {
                    container.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 40px;">Play more games to see insights!</p>';
                }
                
            } catch (error) {
                console.error('‚ùå Error generating insights:', error);
                const container = document.getElementById('insights-container');
                if (container) {
                    container.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 40px;">Unable to load insights</p>';
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üìä Analysis page initializing...');
            
            // Initialize auth
            if (typeof initializeAuth === 'function') {
            currentUser = await initializeAuth();
            } else if (window.authManager && window.authManager.user) {
                currentUser = window.authManager.user;
            }
            
            console.log('‚úÖ Analysis page loaded with user:', currentUser);
            
            // Load analytics data
            if (currentUser && (currentUser.id || currentUser.userId)) {
                const userId = currentUser.id || currentUser.userId;
                currentUser.id = userId; // Normalize
                await loadAnalyticsData();
            } else {
                console.warn('‚ö†Ô∏è No user logged in - analytics data will not load');
                const statsGrid = document.getElementById('analytics-stats-grid');
                if (statsGrid) {
                    statsGrid.innerHTML = `
                        <div class="empty-state-modern" style="grid-column: 1 / -1;">
                            <div class="empty-state-modern-icon">üîê</div>
                            <h3>Please log in</h3>
                            <p>Sign in to view your analytics dashboard</p>
                        </div>
                    `;
                }
            }
            
            // Connect to live data stream
            if (window.analyticsService) {
                window.analyticsService.connect();
                console.log('üìä Analytics Observatory initialized');
            }
        });
    </script>

    <!-- Liquid Glass SVG Filter -->
    <svg xmlns="http://www.w3.org/2000/svg" width="0" height="0" style="position:absolute; overflow:hidden">
        <defs>
            <filter id="glass-distortion" x="0%" y="0%" width="100%" height="100%">
                <feTurbulence type="fractalNoise" baseFrequency="0.008 0.008" numOctaves="2" seed="92" result="noise" />
                <feGaussianBlur in="noise" stdDeviation="2" result="blurred" />
                <feDisplacementMap in="SourceGraphic" in2="blurred" scale="77" xChannelSelector="R" yChannelSelector="G" />
            </filter>
        </defs>
    </svg>
</body>
</html>
