<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ COMPREHENSIVE POKER TEST</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .container {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .error {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        input, select {
            padding: 12px;
            margin: 8px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }
        
        input::placeholder {
            color: rgba(255,255,255,0.7);
        }
        
        .game-info {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .player-card {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #00ff88;
        }
        
        .poker-table {
            background: #0f5132;
            border-radius: 50px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
            border: 3px solid #198754;
            position: relative;
        }
        
        .community-cards {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .card {
            background: white;
            color: #333;
            padding: 10px;
            border-radius: 8px;
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .actions-panel {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        pre {
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-healthy { background: #00ff88; }
        .status-warning { background: #ffaa00; }
        .status-error { background: #ff4444; }
        
        .pot-display {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ COMPREHENSIVE POKER ENGINE TEST</h1>
        <p>Testing the Fixed Sophisticated TypeScript Engine</p>
        <div id="server-status">
            <span class="status-indicator status-warning"></span>
            Checking server status...
        </div>
    </div>

    <div class="grid">
        <div class="container">
            <h2>üè• Server Health</h2>
            <button onclick="checkServerHealth()">Check Health</button>
            <button onclick="testAllEndpoints()">Test All Endpoints</button>
            <div id="health-status"></div>
        </div>

        <div class="container">
            <h2>üéÆ Game Management</h2>
            <input type="number" id="smallBlind" placeholder="Small Blind" value="10">
            <input type="number" id="bigBlind" placeholder="Big Blind" value="20">
            <input type="number" id="maxPlayers" placeholder="Max Players" value="6">
            <button onclick="createGame()">Create Game</button>
            <button onclick="listGames()">List Games</button>
            <div id="game-management"></div>
        </div>
    </div>

    <div class="container">
        <h2>üë• Player Management</h2>
        <div style="display: flex; gap: 15px; align-items: center;">
            <input type="text" id="gameId" placeholder="Game ID">
            <input type="text" id="playerName" placeholder="Player Name" value="Player1">
            <input type="number" id="buyIn" placeholder="Buy-in Amount" value="1000">
            <button onclick="joinGame()">Join Game</button>
        </div>
        <div id="player-management"></div>
    </div>

    <div class="poker-table" id="poker-table" style="display: none;">
        <h2>üÉè POKER TABLE</h2>
        <div class="pot-display" id="pot-display">Pot: $0</div>
        <div class="community-cards" id="community-cards"></div>
        <div id="game-info"></div>
        <div id="players-info"></div>
    </div>

    <div class="container">
        <h2>üéØ Game Actions</h2>
        <div class="actions-panel">
            <button onclick="startHand()" id="start-hand-btn" disabled>Start Hand</button>
            <button onclick="getGameState()">Get Game State</button>
            <button onclick="getLegalActions()" id="legal-actions-btn" disabled>Get Legal Actions</button>
        </div>
        
        <div class="actions-panel" id="player-actions" style="display: none;">
            <h3>Player Actions</h3>
            <select id="action-type">
                <option value="FOLD">Fold</option>
                <option value="CHECK">Check</option>
                <option value="CALL">Call</option>
                <option value="BET">Bet</option>
                <option value="RAISE">Raise</option>
                <option value="ALL_IN">All In</option>
            </select>
            <input type="number" id="action-amount" placeholder="Amount" min="0">
            <button onclick="performAction()">Perform Action</button>
        </div>
        
        <div id="action-results"></div>
    </div>

    <div class="container">
        <h2>üîç Debug Information</h2>
        <button onclick="clearDebugLog()">Clear Log</button>
        <button onclick="exportGameState()">Export Game State</button>
        <div id="debug-log"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        let currentGameId = null;
        let currentPlayerId = null;
        let gameState = null;

        function log(message, type = 'info') {
            const debugDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#74b9ff',
                success: '#00b894',
                error: '#e17055',
                warning: '#fdcb6e'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type];
            logEntry.style.margin = '5px 0';
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            debugDiv.appendChild(logEntry);
            debugDiv.scrollTop = debugDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        async function makeRequest(url, options = {}) {
            try {
                log(`üåê Making request to: ${url}`);
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                log(`‚úÖ Response received (${response.status})`, 'success');
                return data;
            } catch (error) {
                log(`‚ùå Request failed: ${error.message}`, 'error');
                throw error;
            }
        }

        async function checkServerHealth() {
            try {
                const data = await makeRequest(`${API_BASE}/health`);
                const statusElement = document.getElementById('server-status');
                statusElement.innerHTML = `
                    <span class="status-indicator status-healthy"></span>
                    Server healthy - ${data.engine}
                `;
                
                document.getElementById('health-status').innerHTML = `
                    <div class="success">
                        ‚úÖ Server is healthy!<br>
                        Engine: ${data.engine}<br>
                        Components: ${Object.keys(data.components).join(', ')}<br>
                        Uptime: ${Math.floor(data.uptime)}s
                    </div>
                `;
                log('Health check successful', 'success');
                return true;
            } catch (error) {
                const statusElement = document.getElementById('server-status');
                statusElement.innerHTML = `
                    <span class="status-indicator status-error"></span>
                    Server offline
                `;
                
                document.getElementById('health-status').innerHTML = `
                    <div class="error">‚ùå Server is not responding: ${error.message}</div>
                `;
                log(`Health check failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function testAllEndpoints() {
            log('üß™ Testing all endpoints...', 'info');
            
            const endpoints = [
                { name: 'Root', url: '/', method: 'GET' },
                { name: 'Health', url: '/health', method: 'GET' },
                { name: 'List Games', url: '/api/games', method: 'GET' }
            ];
            
            let passed = 0;
            let failed = 0;
            
            for (const endpoint of endpoints) {
                try {
                    await makeRequest(`${API_BASE}${endpoint.url}`);
                    log(`‚úÖ ${endpoint.name} endpoint working`, 'success');
                    passed++;
                } catch (error) {
                    log(`‚ùå ${endpoint.name} endpoint failed: ${error.message}`, 'error');
                    failed++;
                }
            }
            
            log(`üìä Endpoint test complete: ${passed} passed, ${failed} failed`, passed === endpoints.length ? 'success' : 'warning');
        }

        async function createGame() {
            try {
                const smallBlind = parseInt(document.getElementById('smallBlind').value);
                const bigBlind = parseInt(document.getElementById('bigBlind').value);
                const maxPlayers = parseInt(document.getElementById('maxPlayers').value);

                const data = await makeRequest(`${API_BASE}/api/games`, {
                    method: 'POST',
                    body: JSON.stringify({
                        small_blind: smallBlind,
                        big_blind: bigBlind,
                        max_players: maxPlayers
                    })
                });

                currentGameId = data.gameId;
                document.getElementById('gameId').value = currentGameId;
                
                document.getElementById('game-management').innerHTML = `
                    <div class="success">
                        ‚úÖ Game created successfully!<br>
                        <strong>Game ID:</strong> ${data.gameId}<br>
                        <strong>Status:</strong> ${data.status}<br>
                        <strong>Engine:</strong> ${data.engine}<br>
                        <strong>Can Start Hand:</strong> ${data.canStartHand ? 'Yes' : 'No'}
                    </div>
                `;
                
                log(`Game created: ${data.gameId}`, 'success');
                updateUI();
            } catch (error) {
                document.getElementById('game-management').innerHTML = `
                    <div class="error">‚ùå Failed to create game: ${error.message}</div>
                `;
                log(`Game creation failed: ${error.message}`, 'error');
            }
        }

        async function joinGame() {
            try {
                const gameId = document.getElementById('gameId').value;
                const playerName = document.getElementById('playerName').value;
                const buyIn = parseInt(document.getElementById('buyIn').value);

                if (!gameId) {
                    throw new Error('Please enter a game ID');
                }

                const data = await makeRequest(`${API_BASE}/api/games/${gameId}/join`, {
                    method: 'POST',
                    body: JSON.stringify({
                        player_name: playerName,
                        buy_in_amount: buyIn
                    })
                });

                currentPlayerId = data.playerId;
                if (!currentGameId) currentGameId = gameId;
                
                document.getElementById('player-management').innerHTML = `
                    <div class="success">
                        ‚úÖ Joined game successfully!<br>
                        <strong>Player ID:</strong> ${data.playerId}<br>
                        <strong>Seat:</strong> ${data.seatIndex}<br>
                        <strong>Players:</strong> ${data.playerCount}<br>
                        <strong>Can Start:</strong> ${data.canStart ? 'Yes' : 'No'}
                    </div>
                `;
                
                log(`Joined game: ${gameId} as ${playerName}`, 'success');
                updateUI();
                
                if (data.canStart) {
                    document.getElementById('start-hand-btn').disabled = false;
                }
            } catch (error) {
                document.getElementById('player-management').innerHTML = `
                    <div class="error">‚ùå Failed to join game: ${error.message}</div>
                `;
                log(`Join game failed: ${error.message}`, 'error');
            }
        }

        async function startHand() {
            try {
                if (!currentGameId) {
                    throw new Error('No game selected');
                }

                const data = await makeRequest(`${API_BASE}/api/games/${currentGameId}/start-hand`, {
                    method: 'POST'
                });

                document.getElementById('poker-table').style.display = 'block';
                log(`Hand started: #${data.handNumber}`, 'success');
                
                updatePokerTable(data);
                updateUI();
                
                if (data.toAct) {
                    document.getElementById('legal-actions-btn').disabled = false;
                    document.getElementById('player-actions').style.display = 'block';
                }
                
            } catch (error) {
                log(`Start hand failed: ${error.message}`, 'error');
            }
        }

        async function getGameState() {
            try {
                if (!currentGameId) {
                    throw new Error('No game selected');
                }

                gameState = await makeRequest(`${API_BASE}/api/games/${currentGameId}`);
                
                updatePokerTable(gameState);
                log('Game state retrieved', 'success');
                
            } catch (error) {
                log(`Get game state failed: ${error.message}`, 'error');
            }
        }

        async function getLegalActions() {
            try {
                if (!currentGameId || !currentPlayerId) {
                    throw new Error('No game or player selected');
                }

                const data = await makeRequest(`${API_BASE}/api/games/${currentGameId}/legal-actions?player_id=${currentPlayerId}`);
                
                document.getElementById('action-results').innerHTML = `
                    <div class="game-info">
                        <h3>Legal Actions for ${currentPlayerId}</h3>
                        <strong>Actions:</strong> ${data.legalActions.join(', ')}<br>
                        <strong>Current Bet:</strong> $${data.bettingInfo.currentBet}<br>
                        <strong>Min Raise:</strong> $${data.bettingInfo.minRaise}<br>
                        <strong>Pot:</strong> $${data.bettingInfo.pot}<br>
                        <strong>To Act:</strong> ${data.bettingInfo.toAct}
                    </div>
                `;
                
                log(`Legal actions: ${data.legalActions.join(', ')}`, 'success');
                
            } catch (error) {
                log(`Get legal actions failed: ${error.message}`, 'error');
            }
        }

        async function performAction() {
            try {
                if (!currentGameId || !currentPlayerId) {
                    throw new Error('No game or player selected');
                }

                const actionType = document.getElementById('action-type').value;
                const amount = document.getElementById('action-amount').value;

                const data = await makeRequest(`${API_BASE}/api/games/${currentGameId}/actions`, {
                    method: 'POST',
                    body: JSON.stringify({
                        player_id: currentPlayerId,
                        action: actionType,
                        amount: amount ? parseInt(amount) : undefined
                    })
                });

                updatePokerTable(data);
                
                document.getElementById('action-results').innerHTML = `
                    <div class="success">
                        ‚úÖ Action performed: ${actionType} ${amount ? `$${amount}` : ''}<br>
                        <strong>Street:</strong> ${data.street}<br>
                        <strong>Pot:</strong> $${data.pot}<br>
                        <strong>Next to Act:</strong> ${data.toAct || 'None'}<br>
                        <strong>Betting Round Complete:</strong> ${data.isBettingRoundComplete ? 'Yes' : 'No'}
                    </div>
                `;
                
                log(`Action performed: ${actionType} ${amount || ''}`, 'success');
                
            } catch (error) {
                document.getElementById('action-results').innerHTML = `
                    <div class="error">‚ùå Action failed: ${error.message}</div>
                `;
                log(`Action failed: ${error.message}`, 'error');
            }
        }

        function updatePokerTable(data) {
            // Update pot
            document.getElementById('pot-display').textContent = `Pot: $${data.pot || 0}`;
            
            // Update community cards
            const communityCards = document.getElementById('community-cards');
            communityCards.innerHTML = '';
            if (data.communityCards && data.communityCards.length > 0) {
                data.communityCards.forEach(card => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card';
                    cardDiv.textContent = card;
                    communityCards.appendChild(cardDiv);
                });
            } else {
                communityCards.innerHTML = '<div class="card" style="background: #666; color: white;">?</div>'.repeat(5);
            }
            
            // Update game info
            document.getElementById('game-info').innerHTML = `
                <div class="game-info">
                    <strong>Hand:</strong> #${data.handNumber || 'N/A'} | 
                    <strong>Street:</strong> ${data.street || 'N/A'} | 
                    <strong>Status:</strong> ${data.status || 'N/A'}<br>
                    <strong>Current Bet:</strong> $${data.currentBet || 0} | 
                    <strong>To Act:</strong> ${data.toAct || 'None'}
                </div>
            `;
            
            // Update players
            if (data.players) {
                const playersDiv = document.getElementById('players-info');
                playersDiv.innerHTML = '<h3>Players</h3>';
                data.players.forEach(player => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'player-card';
                    playerDiv.innerHTML = `
                        <strong>${player.name}</strong> (Seat ${player.seatIndex})<br>
                        Stack: $${player.stack} | Bet: $${player.betThisStreet || 0}<br>
                        Status: ${player.hasFolded ? 'Folded' : player.isAllIn ? 'All-In' : 'Active'}
                        ${player.holeCards && player.holeCards.length > 0 ? `<br>Cards: ${player.holeCards.join(', ')}` : ''}
                    `;
                    playersDiv.appendChild(playerDiv);
                });
            }
        }

        function updateUI() {
            // Enable/disable buttons based on current state
            if (currentGameId) {
                document.getElementById('legal-actions-btn').disabled = !currentPlayerId;
            }
        }

        async function listGames() {
            try {
                const data = await makeRequest(`${API_BASE}/api/games`);
                
                document.getElementById('game-management').innerHTML = `
                    <div class="game-info">
                        <h3>All Games (${data.total})</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
                log(`Listed ${data.total} games`, 'success');
            } catch (error) {
                log(`List games failed: ${error.message}`, 'error');
            }
        }

        function clearDebugLog() {
            document.getElementById('debug-log').innerHTML = '';
            log('Debug log cleared', 'info');
        }

        function exportGameState() {
            if (gameState) {
                const dataStr = JSON.stringify(gameState, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `game-state-${currentGameId || 'unknown'}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                log('Game state exported', 'success');
            } else {
                log('No game state to export', 'warning');
            }
        }

        // Auto-check health on load
        window.addEventListener('load', () => {
            log('üöÄ Comprehensive Poker Test Client loaded', 'success');
            checkServerHealth();
        });
    </script>
</body>
</html>
