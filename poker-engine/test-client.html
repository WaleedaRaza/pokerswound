<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Game Test Client</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #0f1419;
            color: #e6e6e6;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            border-radius: 10px;
        }
        
        .game-container {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background-color: #1f2937;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #374151;
        }
        
        .poker-table {
            background: linear-gradient(135deg, #065f46, #047857);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            position: relative;
            min-height: 400px;
        }
        
        .community-cards {
            margin: 20px 0;
            padding: 20px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        
        .card {
            display: inline-block;
            width: 40px;
            height: 56px;
            background-color: white;
            color: black;
            border-radius: 6px;
            margin: 0 5px;
            line-height: 56px;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            border: 2px solid #333;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .player-seat {
            background-color: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
        }
        
        .player-seat.active {
            border-color: #fbbf24;
            background-color: rgba(251, 191, 36, 0.1);
        }
        
        .player-seat.to-act {
            border-color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .controls {
            margin-top: 20px;
        }
        
        .btn {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background-color: #2563eb;
        }
        
        .btn:disabled {
            background-color: #6b7280;
            cursor: not-allowed;
        }
        
        .btn-success { background-color: #10b981; }
        .btn-success:hover { background-color: #059669; }
        
        .btn-danger { background-color: #ef4444; }
        .btn-danger:hover { background-color: #dc2626; }
        
        .btn-warning { background-color: #f59e0b; }
        .btn-warning:hover { background-color: #d97706; }
        
        .input-group {
            margin: 10px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #4b5563;
            border-radius: 4px;
            background-color: #374151;
            color: #e5e7eb;
        }
        
        .status {
            background-color: #1f2937;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #3b82f6;
        }
        
        .error {
            border-left-color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
        }
        
        .success {
            border-left-color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
        }
        
        .pot-info {
            font-size: 24px;
            font-weight: bold;
            color: #fbbf24;
            margin: 15px 0;
        }
        
        .game-info {
            font-size: 14px;
            color: #9ca3af;
            margin: 10px 0;
        }
        
        .actions-panel {
            background-color: #374151;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .bet-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        
        .bet-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #4b5563;
            border-radius: 4px;
            background-color: #1f2937;
            color: #e5e7eb;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŽ° Poker Game Test Client</h1>
        <p>Test your poker engine with multiple players</p>
    </div>

    <div class="game-container">
        <!-- Game Setup Panel -->
        <div class="panel">
            <h3>ðŸŽ® Game Setup</h3>
            
            <div class="input-group">
                <label>Small Blind:</label>
                <input type="number" id="smallBlind" value="1" min="1">
            </div>
            
            <div class="input-group">
                <label>Big Blind:</label>
                <input type="number" id="bigBlind" value="2" min="1">
            </div>
            
            <div class="input-group">
                <label>Max Players:</label>
                <input type="number" id="maxPlayers" value="6" min="2" max="10">
            </div>
            
            <button class="btn btn-success" onclick="createGame()">Create Game</button>
            
            <div class="status" id="gameStatus">
                No game created yet
            </div>
            
            <hr style="margin: 20px 0; border-color: #4b5563;">
            
            <h4>ðŸ‘¤ Add Player</h4>
            
            <div class="input-group">
                <label>Player Name:</label>
                <input type="text" id="playerName" placeholder="Enter name">
            </div>
            
            <div class="input-group">
                <label>Buy-in Amount:</label>
                <input type="number" id="buyInAmount" value="100" min="1">
            </div>
            
            <button class="btn" onclick="addPlayer()" id="addPlayerBtn" disabled>Join Game</button>
            
            <button class="btn btn-warning" onclick="startHand()" id="startHandBtn" disabled>Start Hand</button>
        </div>

        <!-- Poker Table -->
        <div class="poker-table">
            <div class="game-info">
                <div>Game ID: <span id="currentGameId">-</span></div>
                <div>Hand #<span id="handNumber">0</span> | Street: <span id="currentStreet">-</span></div>
            </div>
            
            <div class="pot-info">
                ðŸ’° Pot: $<span id="potAmount">0</span>
            </div>
            
            <div class="community-cards">
                <h4>Community Cards</h4>
                <div id="communityCards">
                    <!-- Cards will be inserted here -->
                </div>
            </div>
            
            <div class="players-grid" id="playersGrid">
                <!-- Player seats will be inserted here -->
            </div>
        </div>

        <!-- Player Actions Panel -->
        <div class="panel">
            <h3>ðŸŽ² Player Actions</h3>
            
            <div class="input-group">
                <label>Acting as Player:</label>
                <select id="actingPlayer">
                    <option value="">Select player...</option>
                </select>
            </div>
            
            <div class="status" id="actionsStatus">
                Select a player to see available actions
            </div>
            
            <div class="actions-panel" id="actionsPanel">
                <!-- Action buttons will be inserted here -->
            </div>
            
            <div class="bet-input" id="betInput" style="display: none;">
                <label>Amount:</label>
                <input type="number" id="betAmount" min="1" placeholder="Enter amount">
                <button class="btn" onclick="placeBet()">Place Bet</button>
            </div>
            
            <hr style="margin: 20px 0; border-color: #4b5563;">
            
            <h4>ðŸ”„ Game Controls</h4>
            <button class="btn" onclick="refreshGameState()" id="refreshBtn" disabled>Refresh State</button>
            <button class="btn btn-danger" onclick="resetGame()">Reset</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Game state
        let currentGame = null;
        let currentPlayers = [];
        let playerCount = 0;
        let socket = null;

        // API base URL
        const API_BASE = 'http://localhost:3000/api';

        // Initialize WebSocket connection
        function initWebSocket() {
            socket = io('http://localhost:3000', { path: '/ws' });
            
            socket.on('connect', () => {
                console.log('Connected to server');
                if (currentGame) {
                    socket.emit('join', `game:${currentGame.gameId}`);
                }
            });
            
            socket.on('GAME_CREATED', (data) => {
                showStatus('Game created successfully!', 'success');
            });
            
            socket.on('PLAYER_JOINED', (data) => {
                showStatus(`${data.playerName} joined the game`, 'success');
                refreshGameState();
            });
            
            socket.on('HAND_STARTED', (data) => {
                showStatus('New hand started!', 'success');
                refreshGameState();
            });
            
            socket.on('PLAYER_ACTION', (data) => {
                showStatus(`Player action: ${data.action}`, 'success');
                refreshGameState();
            });
            
            socket.on('STREET_ADVANCED', (data) => {
                showStatus(`Advanced to ${data.street}`, 'success');
                refreshGameState();
            });
            
            socket.on('HAND_COMPLETED', (data) => {
                showStatus('Hand completed!', 'success');
                refreshGameState();
            });
        }

        // Create a new game
        async function createGame() {
            const smallBlind = parseInt(document.getElementById('smallBlind').value);
            const bigBlind = parseInt(document.getElementById('bigBlind').value);
            const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
            
            try {
                const response = await fetch(`${API_BASE}/games`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        small_blind: smallBlind,
                        big_blind: bigBlind,
                        max_players: maxPlayers
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create game');
                }
                
                currentGame = await response.json();
                document.getElementById('currentGameId').textContent = currentGame.gameId;
                document.getElementById('addPlayerBtn').disabled = false;
                
                showStatus('Game created successfully!', 'success');
                
                // Join WebSocket room
                if (socket) {
                    socket.emit('join', `game:${currentGame.gameId}`);
                }
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Add a player to the game
        async function addPlayer() {
            const playerName = document.getElementById('playerName').value.trim();
            const buyInAmount = parseInt(document.getElementById('buyInAmount').value);
            
            if (!playerName) {
                showStatus('Please enter a player name', 'error');
                return;
            }
            
            if (!currentGame) {
                showStatus('Please create a game first', 'error');
                return;
            }
            
            try {
                const playerId = `player_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const response = await fetch(`${API_BASE}/games/${currentGame.gameId}/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        player_id: playerId,
                        player_name: playerName,
                        buy_in_amount: buyInAmount
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to join game');
                }
                
                const result = await response.json();
                playerCount++;
                
                // Add to player selector
                const select = document.getElementById('actingPlayer');
                const option = document.createElement('option');
                option.value = playerId;
                option.textContent = playerName;
                select.appendChild(option);
                
                // Clear input
                document.getElementById('playerName').value = '';
                
                // Enable start hand button if enough players
                if (playerCount >= 2) {
                    document.getElementById('startHandBtn').disabled = false;
                }
                
                document.getElementById('refreshBtn').disabled = false;
                
                showStatus(`${playerName} joined the game!`, 'success');
                refreshGameState();
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Start a new hand
        async function startHand() {
            if (!currentGame) {
                showStatus('No game found', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/games/${currentGame.gameId}/start-hand`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to start hand');
                }
                
                const result = await response.json();
                showStatus('Hand started!', 'success');
                refreshGameState();
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Refresh game state
        async function refreshGameState() {
            if (!currentGame) return;
            
            try {
                const response = await fetch(`${API_BASE}/games/${currentGame.gameId}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to get game state');
                }
                
                const gameState = await response.json();
                updateGameDisplay(gameState);
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Update game display
        function updateGameDisplay(gameState) {
            // Update basic info
            document.getElementById('handNumber').textContent = gameState.handNumber || 0;
            document.getElementById('currentStreet').textContent = gameState.street || 'WAITING';
            document.getElementById('potAmount').textContent = gameState.pot || 0;
            
            // Update community cards
            const communityCardsDiv = document.getElementById('communityCards');
            if (gameState.communityCards && gameState.communityCards.length > 0) {
                communityCardsDiv.innerHTML = gameState.communityCards.map(card => 
                    `<span class="card">${card}</span>`
                ).join('');
            } else {
                communityCardsDiv.innerHTML = '<em>No cards dealt yet</em>';
            }
            
            // Update players
            const playersGrid = document.getElementById('playersGrid');
            playersGrid.innerHTML = '';
            
            if (gameState.players) {
                gameState.players.forEach((player, index) => {
                    const seatDiv = document.createElement('div');
                    seatDiv.className = 'player-seat';
                    
                    if (player.isActive && !player.hasFolded) {
                        seatDiv.classList.add('active');
                    }
                    
                    if (player.id === gameState.toAct) {
                        seatDiv.classList.add('to-act');
                    }
                    
                    seatDiv.innerHTML = `
                        <div><strong>${player.name}</strong></div>
                        <div>Seat ${player.seatIndex}</div>
                        <div>$${player.stack}</div>
                        <div class="game-info">
                            ${player.hasFolded ? 'FOLDED' : 
                              player.isAllIn ? 'ALL-IN' : 
                              player.isActive ? 'ACTIVE' : 'SITTING OUT'}
                        </div>
                        ${player.betThisStreet ? `<div>Bet: $${player.betThisStreet}</div>` : ''}
                    `;
                    
                    playersGrid.appendChild(seatDiv);
                });
            }
            
            // Update legal actions for selected player
            updateLegalActions();
        }

        // Update legal actions for selected player
        async function updateLegalActions() {
            const selectedPlayer = document.getElementById('actingPlayer').value;
            if (!selectedPlayer || !currentGame) {
                document.getElementById('actionsStatus').textContent = 'Select a player to see available actions';
                document.getElementById('actionsPanel').innerHTML = '';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/games/${currentGame.gameId}/legal-actions?player_id=${selectedPlayer}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to get legal actions');
                }
                
                const result = await response.json();
                const actions = result.legalActions || [];
                
                if (actions.length === 0) {
                    document.getElementById('actionsStatus').textContent = 'No actions available for this player';
                    document.getElementById('actionsPanel').innerHTML = '';
                    return;
                }
                
                document.getElementById('actionsStatus').textContent = `Available actions for ${selectedPlayer}:`;
                
                const actionsPanel = document.getElementById('actionsPanel');
                actionsPanel.innerHTML = '';
                
                actions.forEach(action => {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    button.textContent = action;
                    button.onclick = () => performAction(action);
                    
                    if (action === 'FOLD') button.classList.add('btn-danger');
                    else if (action === 'CHECK' || action === 'CALL') button.classList.add('btn-success');
                    else if (action === 'BET' || action === 'RAISE') button.classList.add('btn-warning');
                    
                    actionsPanel.appendChild(button);
                });
                
                // Show bet input for betting actions
                const needsBetAmount = actions.some(a => ['BET', 'RAISE'].includes(a));
                document.getElementById('betInput').style.display = needsBetAmount ? 'flex' : 'none';
                
            } catch (error) {
                document.getElementById('actionsStatus').textContent = `Error: ${error.message}`;
            }
        }

        // Perform player action
        async function performAction(action) {
            const selectedPlayer = document.getElementById('actingPlayer').value;
            if (!selectedPlayer || !currentGame) return;
            
            let amount = null;
            if (['BET', 'RAISE'].includes(action)) {
                amount = parseInt(document.getElementById('betAmount').value);
                if (!amount || amount <= 0) {
                    showStatus('Please enter a valid bet amount', 'error');
                    return;
                }
            }
            
            try {
                const body = {
                    player_id: selectedPlayer,
                    action: action
                };
                
                if (amount) {
                    body.amount = amount;
                }
                
                const response = await fetch(`${API_BASE}/games/${currentGame.gameId}/actions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to perform action');
                }
                
                const result = await response.json();
                showStatus(`Action performed: ${action}`, 'success');
                
                // Clear bet amount
                document.getElementById('betAmount').value = '';
                
                // Refresh after a short delay to see the update
                setTimeout(refreshGameState, 100);
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Place bet (alternative method)
        function placeBet() {
            const selectedPlayer = document.getElementById('actingPlayer').value;
            if (!selectedPlayer) {
                showStatus('Please select a player first', 'error');
                return;
            }
            
            // This will be handled by the BET or RAISE action
            showStatus('Use the BET or RAISE buttons to place bets', 'error');
        }

        // Reset game
        function resetGame() {
            currentGame = null;
            currentPlayers = [];
            playerCount = 0;
            
            document.getElementById('currentGameId').textContent = '-';
            document.getElementById('handNumber').textContent = '0';
            document.getElementById('currentStreet').textContent = '-';
            document.getElementById('potAmount').textContent = '0';
            document.getElementById('communityCards').innerHTML = '';
            document.getElementById('playersGrid').innerHTML = '';
            
            document.getElementById('addPlayerBtn').disabled = true;
            document.getElementById('startHandBtn').disabled = true;
            document.getElementById('refreshBtn').disabled = true;
            
            document.getElementById('actingPlayer').innerHTML = '<option value="">Select player...</option>';
            document.getElementById('actionsPanel').innerHTML = '';
            
            showStatus('Game reset', 'success');
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('gameStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Event listeners
        document.getElementById('actingPlayer').addEventListener('change', updateLegalActions);

        // Initialize WebSocket on page load
        window.addEventListener('load', () => {
            initWebSocket();
            showStatus('Ready to create a game!', 'success');
        });
    </script>
</body>
</html>
